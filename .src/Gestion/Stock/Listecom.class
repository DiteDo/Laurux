' Gambas class file

Private $snumcli As String

Public Sub _new(snumcli As String, Org As String, code As String)

  Dim res, res1 As Result
  Dim i, j, k As Integer

  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  $snumcli = snumcli

  res = Utils.db.Exec("SELECT datefac AS dte FROM Fiches_HistoFac WHERE cdclifac=&1 UNION(SELECT datebl as dte FROM Fiches_Bl WHERE cdclibl=&1) ORDER BY dte DESC LIMIT 10", $snumcli)
  If res.Available Then
    GridView1.Header = GridView.Both
    GridView1.ScrollBar = Scroll.Both
    GridView1.Columns.Count = 4
    GridView1.Columns[0].Text = "Designation"
    GridView1.Columns[0].Width = 380
    GridView1.Mode = Select.Single
    GridView1.Columns[1].Text = "Date"
    GridView1.Columns[1].Width = 100
    Inc i
    GridView1.Columns[2].Text = "Quantit√©"
    Inc i
    GridView1.Columns[3].Text = "Px HT"
    Inc i

    i = 0
    res.MoveFirst
    Repeat
      If Org = "H" Then
        res1 = Utils.db.Exec("SELECT SUM(REPLACE(qte_ligfac,',','.')) AS qte,SUM(REPLACE(netht_ligfac,',','.')) as net,code_ligfac as code, datefac as dte FROM Fiches_HistoFac JOIN Fiches_HistoLigfac ON  numfac=num_ligfac WHERE datefac=&1 AND cdclifac=&2 And typel_ligfac='A' GROUP BY code_ligfac UNION(SELECT SUM(REPLACE(qte_ligbl,',','.')) AS qte,SUM(REPLACE(netht_ligbl,',','.')) AS net,code_ligbl as code, datebl as dte FROM Fiches_Bl JOIN Fiches_Ligbl ON num_ligbl=numbl WHERE datebl=&1 AND cdclibl=&2 AND typel_ligbl='A' GROUP BY code_ligbl)", res!dte, $snumcli)
      Else
        res1 = Utils.db.Exec("SELECT SUM(REPLACE(qte_ligfac,',','.')) AS qte,SUM(REPLACE(netht_ligfac,',','.')) as net,code_ligfac as code, datefac as dte FROM Fiches_HistoFac JOIN Fiches_HistoLigfac ON  numfac=num_ligfac WHERE datefac=&1 AND cdclifac=&2 And typel_ligfac='A' and  code_ligfac = &3 GROUP BY code_ligfac UNION(SELECT SUM(REPLACE(qte_ligbl,',','.')) AS qte,SUM(REPLACE(netht_ligbl,',','.')) AS net,code_ligbl as code, datebl as dte FROM Fiches_Bl JOIN Fiches_Ligbl ON num_ligbl=numbl WHERE datebl=&1 AND cdclibl=&2 AND code_ligbl= &3 GROUP BY code_ligbl)", res!dte, $snumcli, Code)
      Endif
      res1.MoveFirst
      For k = 0 To res1.Max
        ajouart(res1!code)
        j = 1
        Try GridView1[i, j].Text = Format(res1!dte, "dd/mm/yyyy")
        Inc j
        Try GridView1[i, j].Text = Format(res1!qte, "0.000")
        Inc j
        Try GridView1[i, j].Text = Format(res1!net / res1!qte, "0.000")
        res1.MoveNext
        Inc i
        j = 1
      Next

    Until res.MoveNext()

  Endif

End

Private Sub ajouart(code As String)

  Dim i As Integer
  Dim res As Result

  GridView1.Rows.Count += 1
  i = GridView1.Rows.Max
  res = Utils.db.Exec("SELECT * FROM Fiches_Art WHERE art_code=&1", code)
  Try GridView1.Rows[i].Text = res!art_code
  Try GridView1[i, 0].Text = res!art_design

End
